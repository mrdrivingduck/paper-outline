# Outline

## Full-Speed Fuzzing: Reducing Fuzzing Overhead through Coverage-Guided Tracing - IEEE S&P 2019

Created by : Mr Dk.

2019 / 10 / 12 15:04

Nanjing, Jiangsu, China

---

## 1. Introduction

ä»é«˜å±‚æ¥çœ‹ï¼Œfuzzing åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š

1. ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
2. ç›‘æ§ç”¨ä¾‹å¯¹ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶çš„å½±å“
3. å¤„ç†é‚£äº›æš´éœ² bug æˆ–äº§ç”Ÿ crash çš„æµ‹è¯•ç”¨ä¾‹

æœ€å…ˆè¿›çš„ fuzzer ä¸»è¦è‡´åŠ›äº coverage-guided fuzzing

* è¿½è¸ªæ‰§è¡Œçš„æ§åˆ¶æµï¼Œæ¥è¿½è¸ª coverage
* ä½¿ fuzzer åªéœ€è¦å¯¹ä¸€å°éƒ¨åˆ†è¾“å…¥ (èƒ½å¤Ÿè¿›å…¥ä¹‹å‰æ²¡æœ‰è¿›å…¥çš„ä»£ç åŒºçš„è¾“å…¥) è¿›è¡Œå˜å¼‚

Code coverage æ˜¯ä¸€ç§æŠ½è±¡çš„æ¦‚å¿µï¼ŒåŒ…å«ä¸‰ç§å…·ä½“çš„å½¢å¼ï¼š

* Basic blocks
* Basic block edges
* Basic block paths

å¯¹äºç™½ç›’ (æºä»£ç å¯è·å¾—) çš„å¯æ‰§è¡Œæ–‡ä»¶

* Code coverage æ˜¯é€šè¿‡ç¼–è¯‘æ—¶æ’å…¥ instrumentation å®Œæˆçš„

> Instrumentation è¿™ä¸ªè¯æ€ä¹ˆç¿»è¯‘è‡³ä»Šæä¸æ‡‚...

å¯¹äºé»‘ç›’çš„å¯æ‰§è¡Œæ–‡ä»¶

* é€šè¿‡åŠ¨æ€æˆ–é™æ€çš„ binary rewriting (è¿è¡Œæ—¶?)

è¿½è¸ª code coverage __ä»£ä»·å¾ˆå¤§__

* å æ®äº†å¤§éƒ¨åˆ† fuzzer è¿è¡Œæ—¶æœ€å¤šçš„æ—¶é—´
* å¤§éƒ¨åˆ†æµ‹è¯•ç”¨ä¾‹æ²¡æœ‰å¢åŠ  coverageï¼Œå› æ­¤ coverage ä¿¡æ¯é€šå¸¸ä¼šè¢«ä¸¢å¼ƒ

æ ¹æ®å®éªŒï¼ŒAFL çš„é»‘ç›’æµ‹è¯•ä¼šæœ‰ 13 å€çš„é¢å¤–å¼€é”€ï¼Œç™½ç›’æµ‹è¯•ä¼šæœ‰ 1.7 å€çš„é¢å¤–å¼€é”€

Fuzzing è¿‡ç¨‹ä¸­ 90% çš„æ—¶é—´éƒ½ç”¨äº __æ‰§è¡Œ__ å’Œ __è¿½è¸ª__ æµ‹è¯•ç”¨ä¾‹

* ç»å¤§éƒ¨åˆ†çš„æµ‹è¯•ç”¨ä¾‹åŠå…¶ coverage è¢«ä¸¢å¼ƒ
* æ ¹æ®è¯„ä¼°ï¼Œ10000 ä¸ªæµ‹è¯•ç”¨ä¾‹ä¸­ï¼Œåªæœ‰ä¸åˆ° 1 ä¸ªæµ‹è¯•ç”¨ä¾‹èƒ½å¤Ÿæå‡ coverage
* å› æ­¤ï¼Œç›²ç›®å¯¹æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ coverage è¿›è¡Œè¿½è¸ªå¾ˆæµªè´¹

æœ¬æ–‡æå‡ºçš„æ€æƒ³ï¼šcoverage-guided tracing

* åªè¿½è¸ªé‚£äº›ä¼šå¼•èµ·æ–°çš„ coverage çš„æµ‹è¯•ç”¨ä¾‹

å®ç°æ–¹å¼ï¼š

* å¯¹ç›®æ ‡å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œè½¬æ¢
* å½“æµ‹è¯•ç”¨ä¾‹å¼•èµ·æ–°çš„ coverage æ—¶ï¼Œå¯æ‰§è¡Œæ–‡ä»¶èƒ½å¤Ÿ __è‡ªæˆ‘æ±‡æŠ¥__
* å°†è¿™ç§å˜æ¢åçš„å¯æ‰§è¡Œæ–‡ä»¶ç§°ä¸º _interest oracles_

Interest oracles ä»¥æ­£å¸¸çš„é€Ÿåº¦æ‰§è¡Œç¨‹åº

* å› ä¸ºå®ƒä¸éœ€è¦å¯¹ coverage è¿›è¡Œè¿½è¸ª

å½“ interest oracles æŠ¥å‘Šä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹å¼•å‘äº†æ–°çš„ coverage æ—¶

* æµ‹è¯•ç”¨ä¾‹è¢«æ ‡è®°ä¸º coverage-increasing

* ä½¿ç”¨ä¼ ç»Ÿçš„ coverage è¿½è¸ªï¼Œé‡‡é›† coverage ä¿¡æ¯

* æ¢å¤ interest oracles ä¸­è¢«ä¿®æ”¹çš„éƒ¨åˆ†ï¼Œç»§ç»­è¿›è¡Œ

  > Interest oracles ä¸­çš„è¿™ç§è®¾è®¡è¿˜çœŸæ˜¯å¦™å•Š
  >
  > ä½ è¿˜çœŸä»–å¨˜æ˜¯ä¸ªäººæ‰ ğŸ¤™

è¿™æ ·ï¼Œcoverage-guided tracing å¤„ç† coverage-increasing ç”¨ä¾‹çš„ä»£ä»·è¾ƒé«˜

å´å¯ä»¥ä»¥åŸå§‹é€Ÿåº¦è¿è¡Œæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹

æœ¬æ–‡å®ç°äº† UnTracerï¼Œä¸ AFL çš„ä¸åŒç‰ˆæœ¬è¿›è¡Œäº†æ¯”è¾ƒ

* é»‘ç›’æµ‹è¯•
  * Dynamic binary rewriter - AFL-QEMU
  * Static binary rewriter - AFL-Dyninst
* ç™½ç›’æµ‹è¯•
  * AFL-Clang

Fuzzing çš„ç›®æ ‡æ˜¯ç°å®ä¸–ç•Œä¸­çš„ 8 ä¸ªç¨‹åº

ç»“æœè¡¨æ˜ï¼ŒUnTracer åœ¨æ‰€æœ‰çš„æµ‹è¯•ç¨‹åºä¸­éƒ½è¡¨ç°æœ€å¥½

* å¹³å‡è¿è¡Œæ—¶å¼€é”€ä¸º 0.3% - ç›¸æ¯”äº 612%ã€518%ã€36%

éšç€æ—¶é—´æµé€ï¼Œcoverage-increasing çš„æµ‹è¯•ç”¨ä¾‹çš„æ¯”ä¾‹å¿«é€Ÿè¶‹å‘äº 0

* ä½¿ UnTracer çš„æ€§èƒ½æå‡äº†å››ä¸ªé‡çº§

æœ¬æ–‡çš„ä¸»è¦è´¡çŒ®ï¼š

* æå‡º Coverage-guided tracing - å°† tracing çº¦æŸåˆ°å¼•èµ· coverage å¢å¤šçš„æµ‹è¯•ç”¨ä¾‹
* é‡åŒ–äº† coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹çš„ä¸é¢‘ç¹æ€§
* è¯„ä¼°äº†ä¸åŒç±»å‹çš„ coverage-guided fuzzer åœ¨ tracing ä¸Šæµªè´¹çš„æ—¶é—´
* å®ç°äº† UnTracer
* å°† UnTracer é›†æˆåˆ°æœ€å…ˆè¿›çš„æ··åˆ fuzzer QSYM ä¸­
* å¼€æºäº†æœ¬æ–‡ä¸­çš„å®ç°

---

## 2. Background

### A. An Overview of Fuzzing

Fuzzers é€šå¸¸æ ¹æ® __äº§ç”Ÿæµ‹è¯•ç”¨ä¾‹__ å’Œ __ç›‘æ§ç”¨ä¾‹æ‰§è¡Œ__ çš„æ–¹å¼è¢«åˆ†ç±»ï¼š

* Grammar-based
  * äº§ç”Ÿçš„æµ‹è¯•ç”¨ä¾‹ç”±é¢„å®šä¹‰çš„è¾“å…¥è¯­æ³•çº¦æŸ
* Mutational
  * æµ‹è¯•ç”¨ä¾‹ç”±å¯¹å…¶å®ƒæµ‹è¯•ç”¨ä¾‹è¿›è¡Œå˜å¼‚è€Œäº§ç”Ÿ
  * åœ¨ç¬¬ä¸€è½®è¿­ä»£ä¸­ï¼Œå¯¹ seed ç”¨ä¾‹è¿›è¡Œå˜å¼‚
  * åœ¨éšåçš„è¿­ä»£ä¸­ï¼Œå¯¹å‰ä¸€è½®çš„ç”¨ä¾‹è¿›è¡Œå˜å¼‚

å¯¹äºå¤§å‹åº”ç”¨æ¥è¯´ï¼Œè¾“å…¥è¯­æ³•ååˆ†å¤æ‚

å¯¹äºé—­æºç¨‹åºæ¥è¯´ï¼Œè¾“å…¥è¯­æ³•å¯èƒ½ä¸å¯è·å¾—

å› æ­¤ï¼Œå¤§éƒ¨åˆ†æµè¡Œçš„ fuzzer éƒ½æ˜¯ mutational çš„

Mutational fuzzer åˆ©ç”¨ç¨‹åºåˆ†ææ¥å†³å®šå˜å¼‚å“ªä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹

* Directed fuzzers - ç›®æ ‡æ˜¯åˆ°è¾¾æŒ‡å®šçš„ç¨‹åºåŒºåŸŸ
  * å˜å¼‚ç›®æ ‡æ˜¯é‚£äº›çœ‹èµ·æ¥è·ç¦»æŒ‡å®šåŒºåŸŸæ›´è¿‘çš„æµ‹è¯•ç”¨ä¾‹
* Coverage-guided fuzzers - ç›®æ ‡æ˜¯æ¢ç´¢æ•´ä¸ªå¯æ‰§è¡Œæ–‡ä»¶çš„æ‰€æœ‰ä»£ç 
  * å˜å¼‚ç›®æ ‡æ˜¯é‚£äº›èƒ½å¤Ÿåˆ°è¾¾æ–°çš„ä»£ç åŒºçš„æµ‹è¯•ç”¨ä¾‹

åè€…æ›´ä¸ºæµè¡Œ

åŸºäº fuzzer è¿›è¡Œç¨‹åºåˆ†æçš„ç¨‹åº¦ï¼Œè¿˜å¯ä»¥åˆ†ä¸ºï¼š

* Black-box fuzzers - åªç›‘è§†è¾“å…¥ã€è¾“å‡ºå’Œæ‰§è¡Œè¡Œä¸º
* White-box fuzzers - ä½¿ç”¨é‡é‡çº§çš„ç¨‹åºåˆ†æï¼Œè¿›è¡Œç»†ç²’åº¦çš„æ‰§è¡Œè·¯å¾„ç›‘æ§
* Grey-box fuzzers - æŠ˜è¡·

æœ¬æ–‡çš„å®ç°åŸºäº grey-box fuzzer AFL

### B. Coverage-guided Fuzzing

æœ€å¤§åŒ–æµ‹è¯•ç”¨ä¾‹çš„ coverage

1. é˜Ÿåˆ—ä¸­çš„åˆå§‹ç§å­
2. æµ‹è¯•ç”¨ä¾‹äº§ç”Ÿ - é€‰æ‹©ä¸€ä¸ªç§å­ï¼Œå¹¶å˜å¼‚å¤šæ¬¡
3. ç›‘æ§æ‰§è¡Œè¡Œä¸º - è¿½è¸ª coverage
4. å¦‚æœæµ‹è¯•ç”¨ä¾‹å¼•å‘äº† coverage å¢å¤šï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼›å¦åˆ™ä¸¢å¼ƒ
5. Crash triage
6. å›åˆ°ç¬¬ 2 æ­¥

è¿½è¸ª coverage çš„æ–¹æ³•ï¼š

* binary instrumentation
* system emulation
* ç¡¬ä»¶æ”¯æŒ

æ‰€æœ‰çš„ coverage-guided fuzzer éƒ½åŸºäºä¸‰ç§ coverage åº¦é‡æœºåˆ¶ï¼š

* basic blocks
  * CFG ä¸­çš„ç»“ç‚¹
* basic block edges
  * `<src, dst>` å…ƒç»„
* basic block paths
  * éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œæš‚æ—¶æ²¡æœ‰ç›¸å…³å·¥ä½œ

### C. Coverage Tracing Performance

ç™½ç›’ fuzzer

* åœ¨ç¼–è¯‘ / æ±‡ç¼–é˜¶æ®µï¼Œå°† instrumentation æ’å…¥ä»£ç 
* ç”±å®šåˆ¶çš„ GCC æˆ– Clang å®ç°

é»‘ç›’ fuzzer ç”±äºæ²¡æœ‰æºä»£ç 

* éœ€è¦èŠ±è´¹å¾ˆå¤§ä»£ä»·é‡å»º control-flow
* å¼•å…¥çš„å¼€é”€ä¸æ­£å¸¸æ‰§è¡Œé€Ÿåº¦ç›¸æ¯”ï¼Œå¤šäº† 1000%

### D. Focus of This Paper

Coverage-guided fuzzing çš„ä¸€ä¸ªç‰¹æ€§å°±æ˜¯è¿½è¸ªæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹çš„ coverage

é€šè¿‡ "smarter" çš„ç”¨ä¾‹ç”Ÿæˆç­–ç•¥ï¼Œèƒ½å¤Ÿæå‡ coverage-increasing çš„ç”¨ä¾‹æ¯”ä¾‹

* è€Œ coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹ä¾æ—§å¾ˆå°‘
* å¯¹ non-coverage-increasing çš„ç”¨ä¾‹è¿›è¡Œ tracing
* æ„å‘³ç€æœ‰æå‡ fuzzing æ€§èƒ½çš„æœºä¼š

æœ¬æ–‡æå‡ºäº† coverage-guided tracing

* åªå¯¹ coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œ coverage è¿½è¸ª

---

## 3. Impact of Discarded Test Cases

ä¼ ç»Ÿçš„ coverage-guided fuzzer AFL

* åŸºäºä¸€ç§ç›²ç›® (éšæœºå˜å¼‚) çš„æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆç­–ç•¥
* ä¸å¼•èµ· coverage å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹ä¼šè¢«ä¸¢å¼ƒ

ä¸ºäº†å‡å°‘è¿™ç§æµ‹è¯•ç”¨ä¾‹çš„æ¯”ä¾‹

* ä¸€äº› fuzzer ä½¿ç”¨äº†èªæ˜ä¸€äº›çš„æµ‹è¯•ç”¨ä¾‹ç”Ÿæˆç­–ç•¥
* åˆ©ç”¨æºä»£ç åˆ†æï¼Œä»è€Œèƒ½å¤Ÿäº§ç”Ÿæ›´é«˜æ¯”ä¾‹çš„ coverage-increasing æµ‹è¯•ç”¨ä¾‹

ç„¶è€Œï¼Œhow effective?

åœ¨è¿™ä¸€ç« èŠ‚ï¼Œç ”ç©¶äº† non-coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹å¯¹ fuzzer æ‰§è¡Œ / è¿½è¸ªçš„å½±å“

* AFL - blind test case generation
* Driller - smart test case generation

AFL è¿½è¸ªæµ‹è¯•ç”¨ä¾‹ coverage çš„æ–¹å¼ï¼š

* é»‘ç›’ - QEMU-based dynamic instrumentation
* ç™½ç›’ - ç¼–è¯‘ / æ±‡ç¼–æ—¶çš„ instrumentation

Driller è¿½è¸ªæµ‹è¯•ç”¨ä¾‹ coverage çš„æ–¹å¼ï¼š

* é€‰æ‹©æ€§çš„ç¬¦å·æ‰§è¡Œ - è§£å†³éƒ¨åˆ†è·¯å¾„çº¦æŸ
* äº§ç”Ÿæ›´å°‘çš„ non-coverage-increasing ç”¨ä¾‹
* ç¬¦å·æ‰§è¡Œèƒ½å¤Ÿä½¿ fuzzer çªç ´ AFL å¯èƒ½ä¼šè¢«å¡æ­»çš„åœ°æ–¹ (magic value)

### A. Experimental Setup

ä¸ºäº†è®¡ç®—æ¯ä¸ª fuzzer çš„æ‰§è¡Œ / è¿½è¸ªæ—¶é—´

åœ¨ AFL çš„æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå‡½æ•° `run_target()` ä¸­æ’å…¥è®¡æ—¶ä»£ç 

ç”±äºè®¡æ—¶åœ¨æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹è¢«æ‰§è¡Œæ—¶éƒ½ä¼šè¿›è¡Œ

* é¡ºä¾¿å¯ä»¥ç”¨äºè®¡ç®—äº§ç”Ÿçš„æµ‹è¯•ç”¨ä¾‹çš„æ€»æ•°

è®¡ç®—æ¯ä¸ª fuzzer çš„ coverage-increasing æµ‹è¯•ç”¨ä¾‹

* åœ¨ AFL çš„é˜Ÿåˆ—ç›®å½•ä¸­ï¼Œå¯»æ‰¾æ‰€æœ‰ä¿å­˜çš„ç”¨ä¾‹ä¸­ï¼Œé™„åŠ äº† `+cov` çš„æ ·ä¾‹

### B. Results

AFL å’Œ Driller å°†ä¸»è¦æ—¶é—´ (90%) éƒ½èŠ±è´¹åœ¨äº†æµ‹è¯•ç”¨ä¾‹æ‰§è¡Œ / coverage è¿½è¸ªä¸Š

è€Œå…¶ä¸­å¼•å‘ coverage å¢å¤šçš„ç”¨ä¾‹å æœ‰çš„æ¯”ä¾‹ï¼š

* AFL-Clang: 0.0062%
* AFL-QEMU: 0.0257%
* Driller-AFL: 0.00653%

å®éªŒè¡¨æ˜ï¼Œfuzzer æŠŠä¸»è¦çš„æ—¶é—´ï¼Œéƒ½èŠ±åœ¨æ‰§è¡Œ / è¿½è¸ª non-coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹ä¸Š

---

## 4. Coverage-guided Tracing

ç›®å‰çš„ coverage fuzzer è¿½è¸ªæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹

* å°†ç”¨ä¾‹è‡ªèº«çš„ coverage ä¸æŸä¸ªå…¨å±€ç´¯åŠ çš„ coverage è¿›è¡Œæ¯”è¾ƒ
* å¼•å‘ coverage å¢åŠ çš„æ ·ä¾‹è¢«ç•™ä¸‹ç”¨äºå˜å¼‚
* ä¸å¼•å‘ coverage å¢åŠ çš„æ ·ä¾‹åŠå…¶ coverage ä¿¡æ¯ä¸€èµ·è¢«ä¸¢å¼ƒ

Coverage-guided tracing çš„ç›®æ ‡æ˜¯ï¼š

* åªå¯¹å¼•èµ· coverage å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œè¿½è¸ª

### A. Overview

åœ¨ __test case generation__ å’Œ __code coverage tracing__ ä¹‹é—´å¼•å…¥ä¸€ä¸ªä¸­é—´æ­¥éª¤ - __interest oracle__

* è¿™æ˜¯ä¸€ä¸ªå¯¹äºç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¿®æ”¹ç‰ˆæœ¬
* ä¸€ä¸ªé¢„é€‰æ‹©çš„ __è½¯ä»¶ä¸­æ–­__ è¢«è¦†ç›–åˆ°æ¯ä¸ª __æœªè¢«è¦†ç›–__ çš„ basic block çš„å¼€å¤´å¤„
* è§¦å‘è½¯ä»¶ä¸­æ–­çš„æµ‹è¯•ç”¨ä¾‹è¢«æ ‡è®°ä¸º coverage-increasingï¼Œå¹¶è¢«è¿½è¸ª coverage
* æ–°è¢«è¦†ç›–çš„ basic block è¢«è®°å½•åï¼Œå¯¹åº” basic block ä¸­çš„è½¯ä»¶ä¸­æ–­è¢«ç§»é™¤ (unmodifying)
* éšç€ fuzzing çš„ç»§ç»­è¿›è¡Œï¼Œåªæœ‰è¦†ç›–æ–°çš„ basic block çš„æµ‹è¯•ç”¨ä¾‹æ‰ä¼šè§¦å‘è½¯ä»¶ä¸­æ–­

Coverage-guided tracing å¯¹ fuzzing çš„å¢å¼ºä½“ç°åœ¨ï¼š

1. Determine Interesting: å°†æµ‹è¯•ç”¨ä¾‹è¿è¡Œäº interest oracle ä¸Šï¼Œè‹¥è§¦å‘è½¯ä»¶ä¸­æ–­ï¼Œåˆ™æ ‡è®°ä¸º coverage-increasing
2. Full Tracing: å¯¹äºæ¯ä¸ª coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹ï¼Œè¿½è¸ªå…¶å®Œæ•´çš„ code coverage
3. Unmodify Oracle: å¯¹äº coverage ä¸­ç¬¬ä¸€æ¬¡è¢«è®¿é—®çš„ basic blockï¼Œç§»é™¤å…¶ä¸­çš„è½¯ä»¶ä¸­æ–­

### B. The Interest Oracle

è¿‡æ»¤ä¸å¼•èµ· coverage å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹ï¼Œé˜²æ­¢å®ƒä»¬è¢«è¿½è¸ª coverage

ç»™å®šä¸€ä¸ªç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶

Interest oracle æ˜¯ä¸€ä¸ªä¿®æ”¹ç‰ˆæœ¬ï¼Œæ¯ä¸ª basic block çš„å¤´éƒ¨è¢«è¦†ç›–äº†ä¸€ä¸ªè½¯ä»¶ä¸­æ–­

å¦‚æœä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è§¦å‘äº†ä¸­æ–­ï¼Œæ„å‘³ç€æ–°çš„ coverage è¢«å‘ç°

è¿™ä¸ªç”¨ä¾‹ä¹‹åè¢«è¿½è¸ªï¼Œè·å¾—å…¶ full coverage

å…¶ä¸­ï¼Œæ–°è¢«å‘ç°çš„ basic block ä¸­çš„è½¯ä»¶ä¸­æ–­è¢«ç§»é™¤

Interest oracle çš„æ„é€ éœ€è¦ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¯ä¸ª basic block çš„åœ°å€

* æœ‰å¾ˆå¤šç§æ–¹æ³•å¯ä»¥ handle (é™æ€åˆ†æç­‰)

åœ¨æ¯ä¸ª basic block ä¸Šæ’å…¥ä¸­æ–­å¾ˆç®€å•

ä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé‡ç‚¹ï¼š

1. ä»»ä½•ä¸­æ–­ä¿¡å·éƒ½å¯ä»¥è¢«ä½¿ç”¨ï¼Œä½†éœ€è¦é¿å…å’Œ fuzzing è¿‡ç¨‹ä¸­éœ€è¦ç”¨åˆ°çš„ä¿¡å·å†²çª
   * æ¯”å¦‚å’Œ crash å’Œ bug ç­‰æœ‰å…³çš„ä¿¡å·
2. ä¸­æ–­æŒ‡ä»¤çš„ size ä¸èƒ½è¶…è¿‡ä»»ä½• basic block çš„ size
   * ä¸€ä¸ª 1B çš„åŸºæœ¬å—ï¼Œè‚¯å®šè£…ä¸ä¸‹ 2B çš„ä¸­æ–­æŒ‡ä»¤

### C. Tracing

å¯¹äº coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹

ç”¨ä¸€ä¸ª tracing-only ç‰ˆæœ¬çš„äºŒè¿›åˆ¶æ–‡ä»¶ (ä¹Ÿå°±æ˜¯ AFL æœ¬æ¥ç”¨äº fuzzing çš„ç‰ˆæœ¬) æ¥è¿½è¸ªè¿™ä¸ªæµ‹è¯•ç”¨ä¾‹çš„ full coverage

### D. Unmodifying

å°†æ–°å‘ç° coverage çš„ basic block ä¸­çš„ä¸­æ–­æŒ‡ä»¤ï¼Œç”¨æœªè¢«ä¿®æ”¹çš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„æŒ‡ä»¤æ›¿ä»£ (å¤åŸ)

### E. Theoretical Performance Impact

éšç€ fuzzing çš„è¿›è¡Œ

è¶Šæ¥è¶Šå¤šè§¦å‘ coverage å¢å¤šçš„æµ‹è¯•ç”¨ä¾‹å¯¼è‡´æ›´å¤šçš„ basic block è¢«å¤åŸ

* Interest oracle å’ŒåŸç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶çš„å·®å¼‚å°†è¶Šæ¥è¶Šå°
* ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹è§¦å‘ coverage-increasing çš„æ¦‚ç‡ä¹Ÿè¶Šæ¥è¶Šå°

è€Œå¯¹äºä¸è§¦å‘ coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹æ¥è¯´

* åœ¨ç›®æ ‡äºŒè¿›åˆ¶ä¸Šæ‰§è¡Œï¼Œå’Œåœ¨ oracle ä¸Šæ‰§è¡Œï¼Œé€Ÿåº¦æ˜¯ç›¸åŒçš„

éšç€ fuzzing çš„è¿›è¡Œï¼ŒCoverage-guided tracing çš„æ€»ä½“å¼€é”€ä¼šè¶‹è¿‘äº 0

---

## 5. Implementation: UnTracer

### A. UnTracer Overview

UnTracer åŸºäº AFL å®ç°

é¦–å…ˆï¼ŒAFL å®Œæˆå…¶åˆå§‹åŒ–

UnTracer å¯¹ä¸¤ä¸ªç‰ˆæœ¬çš„ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œ instrumentation

- Interest oracle - ç”¨äºè¯†åˆ«å¼•å‘æ–°çš„ coverage çš„æµ‹è¯•ç”¨ä¾‹
  - ä½¿ç”¨é™æ€åˆ†æï¼Œè¯†åˆ«æ‰€æœ‰çš„ basic block
  - æ’å…¥ä¸­æ–­æŒ‡ä»¤
- Tracer - ç”¨äºè¯†åˆ«æ–°çš„ coverage

ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶éƒ½ä¼šå¾—åˆ° forkserver

åœ¨ fuzzer çš„ä¸»å¾ªç¯ä¸­

* UnTracer åœ¨ oracle ä¸Šæ‰§è¡Œæ¯ä¸€ä¸ª AFL äº§ç”Ÿçš„æµ‹è¯•ç”¨ä¾‹
* å¦‚æœæµ‹è¯•ç”¨ä¾‹è§¦å‘ä¸­æ–­ï¼Œé‚£ä¹ˆå°†å…¶æ ‡è®°ä¸º coverage-increasing
* ä½¿ç”¨ tracer é‡‡é›†å…¶ coverage
* åœæ­¢ forkserverï¼Œunmodify æ¯ä¸€ä¸ªæ–°è¦†ç›–çš„ basic block
* é‡å¯ forkserver

AFL å®Œæˆå…¶ coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹çš„å¤„ç†é€»è¾‘

### B. Forkserver Instrumentation

åœ¨ fuzzing è¿‡ç¨‹ä¸­ï¼Œoracle å’Œ tracer éƒ½ä¼šè¢«æ‰§è¡Œå¾ˆå¤šæ¬¡

* Oracle ä¼šæ‰§è¡Œæ‰€æœ‰çš„æµ‹è¯•ç”¨ä¾‹
* Tracer ä¼šæ‰§è¡Œæ‰€æœ‰çš„ coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹

å› æ­¤åœ¨å®ç°ä¸­ï¼Œä½œè€…å†³å®šå¯¹è¿™ä¸¤ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶çš„æ‰§è¡Œè¿›è¡Œä¼˜åŒ–

* åˆ©ç”¨ AFL çš„ forkserver æ¨¡å‹

é€šè¿‡åˆ©ç”¨ `fork()`ï¼Œforkserver é¿å…äº†é‡å¤çš„è¿›ç¨‹åˆå§‹åŒ–å·¥ä½œ

* æ¯”ä¼ ç»Ÿçš„åŸºäº `execve()` çš„æ‰§è¡Œå¥½å¾ˆå¤š - ??? éš¾é“ `execve()` ä¸éœ€è¦ `fork()` ?

é¦–å…ˆï¼Œåœ¨äºŒè¿›åˆ¶æ–‡ä»¶çš„ `.text` åŒºåŸŸä¸­æ’å…¥ forkserver çš„å‡½æ•°

ç„¶åé€šè¿‡ä¸€ä¸ªå›è°ƒï¼Œé“¾æ¥åˆ° `main()` çš„ç¬¬ä¸€ä¸ª basic block

### C. Interest Oracle Binary

ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶çš„ä¿®æ”¹ç‰ˆæœ¬

é€šè¿‡åœ¨æ²¡æœ‰è¢«è¦†ç›–çš„ basic block ä¸­æ’å…¥è½¯ä»¶ä¸­æ–­

å¼•èµ· coverage å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹èƒ½å¤Ÿè¿›è¡Œ __è‡ªæˆ‘æ±‡æŠ¥__

ä¸ºäº†æ’å…¥è½¯ä»¶ä¸­æ–­ï¼Œé¦–å…ˆéœ€è¦çŸ¥é“æ¯ä¸ª basic block çš„åœ°å€

æœ¬æ–‡ä½¿ç”¨äº† Dyninst çš„é™æ€æ§åˆ¶æµåˆ†æï¼Œè¾“å‡ºä¸€ä¸ª basic block çš„åˆ—è¡¨

å¹¶è¿­ä»£æ’å…¥è½¯ä»¶ä¸­æ–­

ä½¿ç”¨äº† `SIGTRAP` ä¿¡å·ä½œä¸ºè½¯ä»¶ä¸­æ–­ï¼š

1. è¢«å¹¿æ³›ç”¨äºç»†ç²’åº¦çš„æ‰§è¡Œæ§åˆ¶å’Œåˆ†æ
2. å…¶äºŒè¿›åˆ¶è¡¨ç¤ºä¸º `0xCC`ï¼Œåªæœ‰ 1Bï¼Œå¯ä»¥è¦†ç›–ä»»ä½• size çš„ basic block

### D. Tracer Binary

ç”¨äºæ‰§è¡Œä¸Šä¸€æ­¥ä¸­é€‰ä¸­çš„å¼•å‘ coverage å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹

* å°† coverage å›è°ƒæ’å…¥åˆ°æ¯ä¸ª basic block ä¸­
* æ¯æ¬¡æ‰§è¡Œæ—¶ï¼Œbasic block ä¸­çš„ callback ä¼šå°† basic block çš„åœ°å€è¿½åŠ åˆ° trace æ–‡ä»¶ä¸­

é—®é¢˜ï¼šå­˜åœ¨åå¤è¢«æ‰§è¡Œçš„ basic block è¢«é‡å¤è®°å½• (æ¯”å¦‚å¾ªç¯)

* æ‹–æ…¢äº† trace æ–‡ä»¶çš„å†™å…¥æ“ä½œ
* è¯»å– trace æ–‡ä»¶ç”¨äºç§»é™¤ä¸­æ–­æ—¶ï¼Œä¹Ÿå­˜åœ¨é‡å¤æ“ä½œ

ä¼˜åŒ–ï¼šåªè®°å½•è¢«è¦†ç›–çš„ basic block ä¸€æ¬¡ï¼Œé˜²æ­¢å¤šæ¬¡è¯»å†™ç›¸åŒçš„ basic block ä¿¡æ¯

* åœ¨ forkserver ä¸­åˆå§‹åŒ–ä¸€ä¸ªå…¨å±€çš„ hashmap
* è®°å½•æ‰€æœ‰è¢«è¦†ç›–çš„ basic block (unique)
* å½“ fork æ—¶ï¼Œè¯¥ hashmap ä¹Ÿè¢«ç»§æ‰¿
* åœ¨æ¯ä¸ª callback ä¸­ï¼Œé€šè¿‡æŸ¥æ‰¾è¿™ä¸ª hashmap æ¥åˆ¤æ–­è¯¥ basic block æ˜¯å¦å·²è¢« cover

### E. Unmodifying the Oracle

å¯¹äºæ–° cover çš„ basic block

ç”¨åŸæ¥çš„ç›®æ ‡äºŒè¿›åˆ¶æ–‡ä»¶ä¸­çš„å¯¹åº”å­—èŠ‚æ›¿æ¢è½¯ä»¶ä¸­æ–­æŒ‡ä»¤

ä¹‹åæµ‹è¯•ç”¨ä¾‹è¿è¡Œåˆ°è¿™ä¸ª basic block å°†ä¸å†ä¼šè§¦å‘è½¯ä»¶ä¸­æ–­

ä»è€Œä¸å†ä¼šè¢«è¯†åˆ«ä¸º coverage å¢åŠ 

ä½œè€…è§‚å¯Ÿåˆ°ä¸€ä¸ªç°è±¡ï¼š

* å¼•èµ· coverage å¢åŠ çš„æµ‹è¯•ç”¨ä¾‹ä¸ä¹‹å‰çš„æµ‹è¯•ç”¨ä¾‹æœ‰è¾ƒå¤šé‡å 
* å¯¼è‡´ UnTracer è¯•å›¾æ¢å¤é‚£äº›å·²ç»è¢«æ¢å¤çš„ basic block

å¯¹ç­–ï¼šä¸€ä¸ªç”¨äºè¿½è¸ªå…¨å±€ coverage çš„ hashmap

* åœ¨å¤åŸæ¯ä¸ª basic block ä¹‹å‰ï¼ŒæŸ¥æ‰¾ hashmap
* å¦‚æœè¯¥ basic block å·²ç»åœ¨ä¹‹å‰è¢«å¤åŸï¼Œåˆ™è·³è¿‡
* å¦åˆ™ç§»é™¤ basic block ä¸­çš„è½¯ä»¶ä¸­æ–­

ä¿è¯äº†åªæœ‰æ–° cover çš„ basic block è¢«å¤„ç†

---

## 6. Tracing-only Evaluation

### A. Evaluation Overview

* UnTracer
* AFL-Clang
* AFL-QEMU
* AFL-Dyninst

è®¡ç®— 8 ä¸ªç°å®ä¸–ç•Œä¸­çš„ç¨‹åºåœ¨å„ä¸ª fuzzer ä¸Šçš„å¼€é”€

ç§»é™¤ AFL ä¸­ä¸ tracing æ— å…³çš„åŠŸèƒ½

å¯¹ `run_target()` å‡½æ•°è¿›è¡Œ instrumentï¼Œé‡‡é›†æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰€èŠ±çš„æ—¶é—´

ä¸ºäº†è¾ƒå°‘ OS è°ƒåº¦å¸¦æ¥çš„å™ªå£°ï¼Œå¯¹æ¯ä¸ªæ•°æ®é›†è¿›è¡Œ 8 æ¬¡æµ‹è¯•

### B. Experiment Infrastructure

åªè®°å½•æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç”¨äºæ‰§è¡Œ / è¿½è¸ªçš„æ—¶é—´

ä½¿ç”¨ QEMU ä½œä¸º baseline tracer

* AFL-Clang
* AFL-QEMU
* AFL-Dyninst
* QEMU (Full speed execution)
* UnTracer (Full speed execution + coverage-guided tracing)

1. ä¾æ¬¡é‡ç°æ•°æ®é›†ä¸­çš„æµ‹è¯•ç”¨ä¾‹
2. æµ‹é‡æ¯ä¸ª test case çš„ tracing æ—¶é—´
3. è®°å½•æ—¶é—´åˆ°æ–‡ä»¶ä¸­

### C. Benchmarks

* bsdtar - å½’æ¡£
* cert-basic - å¯†ç å­¦
* cjson - Web
* djpeg - å›¾åƒå¤„ç†
* pdftohtml - doc
* readelf - dev
* sfconvert - audio
* tcpdump - net

æœ‰å…³ baselineï¼š

* ç”±äºä½¿ç”¨äº† AFL çš„ forkserver ä½œä¸ºä¼˜åŒ–
* ç†è®ºä¸Šæœ€å¿«çš„æ‰§è¡Œæ–¹å¼ï¼š
  * é™æ€ instrumented çš„ forkserverï¼Œä¸ä½œä»»ä½•çš„ coverage tracing
* ä»¥ baseline çš„æ‰§è¡Œæ—¶é—´ä½œä¸ºæ¯”è¾ƒå„ä¸ª fuzzer tracer çš„æ ‡å‡†

### D. Timeout

### E. UnTracer versus Coverage-agnostic Tracing

å°†æœ€åçš„æ‰§è¡Œæ—¶é—´è½¬æ¢ä¸ºç›¸å¯¹äº baseline çš„ç›¸å¯¹æ‰§è¡Œæ—¶é—´

UnTracer é™ä½é»‘ç›’äºŒè¿›åˆ¶æ–‡ä»¶çš„å¼€é”€å››ä¸ªæ•°é‡çº§

### F. Dissecting UnTracer's Overhead

å¯¹äº UnTracer æ¥è¯´ï¼Œå“ªä¸ªæ“ä½œå¯¹æ€§èƒ½å½±å“æœ€å¤§ï¼Ÿ

æ‰€æœ‰æ“ä½œåŒ…å«ï¼š

1. å¯åŠ¨ oracle å’Œ tracer çš„ forkserver
2. åœ¨ oracle ä¸Šæ‰§è¡Œæ‰€æœ‰çš„ test case
3. åœ¨ tracer ä¸Šæ‰§è¡Œ coverage-increasing çš„ test case
4. åœæ­¢ oracle çš„ forkserver
5. Unmodifying basic blocks
6. é‡å¯ oracle çš„ forkserver

è¿è¡Œ non-coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹ä¸åœ¨ baseline ä¸Šæ‰§è¡Œç­‰ä»·

å› æ­¤ UnTracer çš„å”¯ä¸€å¼€é”€æ¥è‡ªå¤„ç† coverage-increasing çš„æµ‹è¯•ç”¨ä¾‹

ä¸ºäº†æµ‹é‡æ¯ä¸ªæ“ä½œä½¿ç”¨çš„æ—¶é—´

* åœ¨æ¯ä¸ªæ“ä½œçš„å¼€å§‹å’Œç»“æŸå¤„åŠ å…¥è®¡æ—¶ä»£ç 
* è®¡ç®—æ¯ä¸ªæ“ä½œåœ¨å¼€é”€ä¸­æ‰€å çš„æ¯”ä¾‹

ç»“æœè¡¨æ˜ï¼Œä¸¤ä¸ªæœ€è€—æ—¶çš„æ“ä½œä¸ºï¼š

* Tracing - å å¼€é”€çš„ 80%
* Forkserver é‡å¯
  * Forkserver çš„åœæ­¢æ—¶é—´æ˜¯æ’å®šçš„
  * é‡å¯éœ€è¦ä½¿ç”¨å¤§é‡çš„è¿›ç¨‹åˆ›å»ºã€è¿›ç¨‹é—´é€šä¿¡

### G. Overhead versus Rate of Coverage-increasing Test Cases

ä¸ AFL ç›¸æ¯”ï¼ŒUnTracer çš„ coverage tracing å¹³å‡æ¥çœ‹è¦æ…¢ä¸€äº›

* å› ä¸ºä½¿ç”¨äº†æ–‡ä»¶æ“ä½œ
* å› æ­¤ï¼Œcoverage-increasing çš„æµ‹è¯•ç”¨ä¾‹è¶Šå°‘ï¼ŒUnTracer çš„ç›¸å¯¹æ€§èƒ½è¶Šå¥½

---

## 7. Hybrid Fuzzing Evaluation

---

## 8. Discussion

### A. UnTracer and Intel Processor Trace

åˆ©ç”¨ç¡¬ä»¶çš„æ”¯æŒï¼Œè¿›è¡Œæ›´æœ‰æ•ˆçš„ coverage tracing

Intel çš„ Processor Trace (PT) æŠ€æœ¯åœ¨ä¿ç•™å†…å­˜ä¸­ï¼Œä¿å­˜äº†ç¨‹åºçš„æ§åˆ¶æµè¡Œä¸º

ç”±äºç›‘æ§ä½äºç¡¬ä»¶å±‚ï¼Œèƒ½å¤Ÿå®Œæ•´è®°å½•å„ç±» coverage ä¿¡æ¯ï¼Œè€Œå¼€é”€é€‚åº¦

ä½† PT æŠ€æœ¯éœ€è¦æŒ‡å®šå‹å· CPU çš„æ”¯æŒï¼Œå¹¶åªå…¼å®¹ x86 çš„å¯æ‰§è¡Œæ–‡ä»¶

### B. Incorporating Edge Coverage Tracking

### C. Comprehensive Black-box Binary Support

---

## Summary

å¾ˆæœ‰æ„æ€ã€‚ã€‚ã€‚

è™½ç„¶è¿™ç¯‡æ–‡ç« çš„æ€è·¯ç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™è¿˜æ²¡æœ‰è¯»æ‡‚

åé¢ä»”ç»†æ¨æ¼”äº†ä¸€ä¸‹ AFL åœ¨æŒ‡ä»¤å±‚æ‰€éœ€è¦åšçš„å·¥ä½œä»¥å

å“å‡ºäº†äº›å‘³å„¿æ¥ ğŸ¤¤

åˆ«çš„å·¥ä½œéƒ½åœ¨æƒ³å°½åŠæ³•æå‡å˜å¼‚å‡ºçš„ test case çš„è´¨é‡

å°½å¯èƒ½å¢å¤§ coverage-increasing çš„ test case çš„æ¯”ä¾‹

è€Œè¿™ç¯‡è®ºæ–‡ç›´æ¥æ¢äº†ä¸€ä¸ªæ€è·¯

ç”¨ä¸€ä¸ªæŒºå¦™çš„æ–¹æ³•ï¼Œåè€Œå¤§å¹…æå‡äº† fuzzing çš„æ€§èƒ½

æˆ‘è€ƒè™‘åœ¨ä¸‹æ¬¡çš„ç»„ä¼šä¸Šåˆ†äº«ä¸€å“ˆ ğŸ‘

---

